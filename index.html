<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaVinciLens Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #FFF9E7; color: #5D4037; font-family: sans-serif; }
        .card { background: white; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.04); }
        .btn-orange { background: linear-gradient(135deg, #E67E22, #D35400); color: white; border-radius: 50px; transition: all 0.2s; }
        .btn-orange:active { transform: scale(0.96); opacity: 0.9; }
    </style>
</head>
<body class="p-6 max-w-md mx-auto min-h-screen">
    <header class="mb-10 text-center pt-4">
        <h1 class="text-2xl font-bold tracking-tight">DaVinciLens é”æ–‡è¥¿é€é¡</h1>
        <p class="text-sm opacity-60 mt-1">æ‰‹å¯«çš„æº«åº¦ï¼Œå¤§å¸«çš„ç¶­åº¦</p>
    </header>

    <div class="card p-8 mb-8 text-center">
        <div class="mb-6 opacity-80 text-lg">åˆ¥è®“ä½ æœ€å¥½çš„éˆæ„Ÿ<br><span class="font-bold text-orange-600">æ­»åœ¨ç­†è¨˜è£¡</span></div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
        <button onclick="document.getElementById('cameraInput').click()" class="btn-orange w-full py-5 text-lg font-bold shadow-lg">
            ğŸ“¸ æ‹ä¸‹ç¬¬ä¸€å‰‡éˆæ„Ÿ
        </button>
    </div>

    <div id="aiSection" class="hidden">
        <div class="flex items-center mb-4 px-2">
            <span class="text-2xl">ğŸ§ </span>
            <div class="flex flex-col ml-3">
                <span id="mentorStatus" class="font-bold text-gray-800 text-sm">æ­£åœ¨å°‹æ‰¾åˆé©çš„å°å¸«ç‰ˆæœ¬...</span>
            </div>
        </div>
        <div id="aiResponse" class="card p-6 text-sm leading-relaxed whitespace-pre-wrap text-gray-700 border-l-4 border-orange-400">
            æ­£åœ¨å•Ÿå‹•å°å¸«...
        </div>
        <div class="mt-4 text-center">
            <button onclick="localStorage.removeItem('my_gemini_key'); location.reload();" class="text-xs text-gray-400 underline">é‡è¨­ API Key</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // 1. å®‰å…¨æ€§ Key æª¢æŸ¥
        let API_KEY = localStorage.getItem('my_gemini_key');
        if (!API_KEY) {
            API_KEY = prompt("è«‹è¼¸å…¥æ‚¨çš„ Gemini API Keyï¼š");
            if (API_KEY) localStorage.setItem('my_gemini_key', API_KEY);
        }

        const genAI = new GoogleGenerativeAI(API_KEY);

        // 2. è‡ªå‹•åˆ¤å®šç‰ˆæœ¬æ¸…å–® (æŒ‰å„ªå…ˆé †åºæ¸¬è©¦)
        const MODEL_CANDIDATES = [
            "gemini-3.0-flash",
            "gemini-2.0-flash-exp",
            "gemini-2.0-flash",
            "gemini-1.5-flash"
        ];

        document.getElementById('cameraInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('aiSection').classList.remove('hidden');
            const responseDiv = document.getElementById('aiResponse');
            const statusDiv = document.getElementById('mentorStatus');
            responseDiv.innerText = "å°å¸«æ­£åœ¨é–±è®€ç­†è¨˜...";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const history = JSON.parse(localStorage.getItem('davinci_history') || "[]");
                
                // 3. å˜—è©¦ä¸åŒç‰ˆæœ¬ç›´åˆ°æˆåŠŸ
                let success = false;
                for (const modelName of MODEL_CANDIDATES) {
                    try {
                        statusDiv.innerText = `æ­£åœ¨å˜—è©¦é€£ç·šï¼š${modelName}...`;
                        const model = genAI.getGenerativeModel({ model: modelName });
                        
                        const prompt = `ä½ æ˜¯ä¸€ä½ç¿æ™ºçš„æ€ç¶­å°å¸«ã€‚è«‹è¾¨è­˜æ­¤ç­†è¨˜ä¸¦çµåˆéå¾€æ‘˜è¦ï¼š\n${history.join('\n')}\nçµ¦å‡ºä¸€å€‹æ·±åˆ»æ´å¯Ÿèˆ‡å•Ÿç™¼å•é¡Œã€‚`;

                        const result = await model.generateContent([
                            prompt,
                            { inlineData: { data: base64Data, mimeType: "image/jpeg" } }
                        ]);

                        const text = result.response.text();
                        responseDiv.innerText = text;
                        statusDiv.innerText = `æ€ç¶­å°å¸« (${modelName}) å·²é€£ç·š`;
                        
                        // å„²å­˜è¨˜æ†¶
                        history.push(`- ${text.substring(0, 50)}`);
                        if (history.length > 5) history.shift();
                        localStorage.setItem('davinci_history', JSON.stringify(history));
                        
                        success = true;
                        break; // æˆåŠŸå°±è·³å‡ºè¿´åœˆ
                    } catch (err) {
                        console.warn(`${modelName} å¤±æ•—:`, err.message);
                        continue; // å¤±æ•—å°±è©¦ä¸‹ä¸€å€‹
                    }
                }

                if (!success) {
                    responseDiv.innerText = "æŠ±æ­‰ï¼Œæ‰€æœ‰æ¨¡å‹ç‰ˆæœ¬çš†ç„¡æ³•é€£ç·šã€‚è«‹æª¢æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ˜¯å¦æœ‰è©²æ¨¡å‹çš„å­˜å–æ¬Šé™ã€‚";
                    statusDiv.innerText = "é€£ç·šå¤±æ•—";
                }
            };
        };
    </script>
</body>
</html>
