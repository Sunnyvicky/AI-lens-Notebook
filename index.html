<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaVinciLens Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #FFF9E7; color: #5D4037; font-family: sans-serif; }
        .card { background: white; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.04); }
        .btn-orange { background: linear-gradient(135deg, #E67E22, #D35400); color: white; border-radius: 50px; }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="p-6 max-w-md mx-auto min-h-screen">
    <header class="mb-10 text-center pt-4">
        <h1 class="text-2xl font-bold tracking-tight">DaVinciLens é”æ–‡è¥¿é€é¡</h1>
        <p class="text-sm opacity-60 mt-1">æ‰‹å¯«çš„æº«åº¦ï¼Œå¤§å¸«çš„ç¶­åº¦</p>
    </header>

    <div class="card p-8 mb-8 text-center border-2 border-orange-100">
        <div class="mb-6 opacity-80 text-lg italic">ã€Œè®“éˆæ„Ÿåœ¨å°è©±ä¸­é‡ç²æ–°ç”Ÿã€</div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
        <button onclick="document.getElementById('cameraInput').click()" class="btn-orange w-full py-5 text-lg font-bold shadow-lg">
            ğŸ“¸ æ‹ä¸‹éˆæ„Ÿ
        </button>
    </div>

    <div id="aiSection" class="hidden">
        <div class="flex items-center mb-4 px-2">
            <span class="text-2xl">ğŸ§ </span>
            <div class="flex flex-col ml-3">
                <span id="mentorStatus" class="font-bold text-gray-800 text-sm">æ­£åœ¨å•Ÿå‹• Gemini 3.0 å°å¸«...</span>
            </div>
        </div>
        <div id="aiResponse" class="card p-6 text-sm leading-relaxed whitespace-pre-wrap text-gray-700 border-l-4 border-orange-400">
            æ­£åœ¨è§£è®€æ‚¨çš„æ€æƒ³...
        </div>
        <div class="mt-6 flex justify-between px-2">
            <button onclick="localStorage.removeItem('davinci_history'); alert('è¨˜æ†¶å·²æ¸…é™¤'); location.reload();" class="text-xs text-gray-400 underline">æ¸…é™¤å°å¸«è¨˜æ†¶</button>
            <button onclick="localStorage.removeItem('my_gemini_key'); location.reload();" class="text-xs text-gray-400 underline">æ›´æ› API Key</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        let API_KEY = localStorage.getItem('my_gemini_key');
        if (!API_KEY) {
            API_KEY = prompt("è«‹è¼¸å…¥æ‚¨çš„ Gemini API Keyï¼š");
            if (API_KEY) localStorage.setItem('my_gemini_key', API_KEY);
        }

        const genAI = new GoogleGenerativeAI(API_KEY);

        // åƒ…ä¿ç•™ Gemini 3.0 ä»¥ä¸Šç‰ˆæœ¬é€²è¡Œæ¸¬è©¦
        const GEMINI_3_MODELS = [
            "gemini-3.0-flash",
            "gemini-3.0-flash-latest",
            "gemini-2.0-flash" // ä½œç‚ºæœ€å¾Œçš„ fallbackï¼Œè‹¥ 3.0 å°šæœªåœ¨æ‚¨çš„å€åŸŸå…¨é¢éƒ¨ç½²
        ];

        document.getElementById('cameraInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('aiSection').classList.remove('hidden');
            const responseDiv = document.getElementById('aiResponse');
            const statusDiv = document.getElementById('mentorStatus');
            responseDiv.innerText = "å°å¸«è®€å–ä¸­...";
            responseDiv.classList.add('loading-pulse');

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                const history = JSON.parse(localStorage.getItem('davinci_history') || "[]");
                
                let success = false;
                for (const modelName of GEMINI_3_MODELS) {
                    try {
                        statusDiv.innerText = `é€£ç·šå˜—è©¦ï¼š${modelName}`;
                        const model = genAI.getGenerativeModel({ model: modelName });
                        
                        const prompt = `ä½ æ˜¯ä¸€ä½ç¿æ™ºçš„æ€ç¶­å°å¸«ã€‚è«‹è¾¨è­˜åœ–ç‰‡å…§å®¹ã€‚
                        åƒè€ƒéå¾€æ‘˜è¦ï¼š${history.join(' | ')}
                        è«‹çµ¦å‡ºï¼š
                        1. ç­†è¨˜æ ¸å¿ƒæ‘˜è¦
                        2. ä¸€å€‹å…·å‚™é«˜åº¦ã€èˆ‡ä»¥å¾€ä¸åŒçš„æ·±åˆ»è¦‹è§£
                        3. ä¸€å€‹èƒ½å¼•ç™¼æ€è€ƒçš„å•é¡Œã€‚`;

                        const result = await model.generateContent([
                            { inlineData: { data: base64Data, mimeType: "image/jpeg" } },
                            { text: prompt }
                        ]);

                        const text = result.response.text();
                        responseDiv.innerText = text;
                        responseDiv.classList.remove('loading-pulse');
                        statusDiv.innerText = `æ€ç¶­å°å¸« (Gemini 3.0) å·²é€£ç·š`;
                        
                        // æ›´æ–°è¨˜æ†¶
                        history.push(text.substring(0, 80));
                        if (history.length > 3) history.shift();
                        localStorage.setItem('davinci_history', JSON.stringify(history));
                        
                        success = true;
                        break;
                    } catch (err) {
                        console.error(`${modelName} éŒ¯èª¤:`, err);
                        if (err.message.includes("404")) continue;
                        break; // è‹¥ä¸æ˜¯ 404 (å¯èƒ½æ˜¯ Key éŒ¯æˆ–æµé‡é™åˆ¶)ï¼Œå‰‡åœæ­¢å˜—è©¦
                    }
                }

                if (!success) {
                    responseDiv.innerText = "âŒ å°å¸«ç„¡æ³•å›æ‡‰ (404 Not Found)\n\né€™ä»£è¡¨ç›®å‰ Gemini 3.0 çš„ API åç¨±å¯èƒ½åœ¨æ‚¨çš„åœ°å€æœ‰æ‰€è®Šå‹•ã€‚è«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦å…·å‚™ Gemini 3.0 çš„å­˜å–æ¬Šé™ã€‚";
                    responseDiv.classList.remove('loading-pulse');
                }
            };
        };
    </script>
</body>
</html>
